# Persistent Scheduling Implementation

> **Version**: 2.0
> **Status**: Implemented
> **Last Updated**: January 2026

## Overview

The persistent scheduling feature enables long-term storage and management of mission schedules, orders, and acquisitions. This replaces the previous localStorage-only approach with a robust SQLite-based persistence layer that survives backend restarts.

## Architecture

```text
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │LeftSidebar  │  │ scheduleApi │  │ ordersStore (Zustand)   │  │
│  │(Promote)    │──│ (API client)│──│ (local state + backup)  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP API
┌────────────────────────────┴────────────────────────────────────┐
│                         Backend                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ /orders     │  │ /schedule   │  │ /planning/schedule      │  │
│  │ (CRUD)      │  │ (horizon,   │  │ (incremental mode)      │  │
│  │             │  │  commit)    │  │                         │  │
│  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘  │
│         │                │                     │                 │
│         └────────────────┼─────────────────────┘                 │
│                          │                                       │
│              ┌───────────┴───────────┐                          │
│              │  schedule_persistence │                          │
│              │  (ScheduleDB class)   │                          │
│              └───────────┬───────────┘                          │
└──────────────────────────┼──────────────────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │   SQLite Database       │
              │   (data/workspaces.db)  │
              │                         │
              │   Tables:               │
              │   - orders              │
              │   - acquisitions        │
              │   - plans               │
              │   - plan_items          │
              │   - conflicts           │
              │   - schema_migrations   │
              └─────────────────────────┘
```

## Database Schema (v2.0)

### Orders Table
Represents user imaging requests (the "inbox" of work to be scheduled).

```sql
CREATE TABLE orders (
    id TEXT PRIMARY KEY,                    -- ord_xxxxxxxxxxxx
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'new',     -- new|planned|committed|cancelled|completed
    target_id TEXT NOT NULL,
    priority INTEGER NOT NULL DEFAULT 3,    -- 1-5
    constraints_json TEXT,                  -- JSON: max_incidence, look_side, etc.
    requested_window_start TEXT,
    requested_window_end TEXT,
    source TEXT DEFAULT 'manual',           -- manual|api|batch
    notes TEXT,
    external_ref TEXT,
    workspace_id TEXT REFERENCES workspaces(id)
);
```

### Acquisitions Table
Committed schedule slots - the authoritative record of what will be executed.

```sql
CREATE TABLE acquisitions (
    id TEXT PRIMARY KEY,                    -- acq_xxxxxxxxxxxx
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    satellite_id TEXT NOT NULL,
    target_id TEXT NOT NULL,
    start_time TEXT NOT NULL,
    end_time TEXT NOT NULL,
    mode TEXT NOT NULL DEFAULT 'OPTICAL',   -- OPTICAL|SAR
    roll_angle_deg REAL NOT NULL,
    pitch_angle_deg REAL DEFAULT 0.0,
    incidence_angle_deg REAL,
    look_side TEXT,                         -- LEFT|RIGHT
    pass_direction TEXT,                    -- ASCENDING|DESCENDING
    sar_mode TEXT,                          -- spot|strip|scan|dwell
    swath_width_km REAL,
    scene_length_km REAL,
    state TEXT NOT NULL DEFAULT 'tentative', -- tentative|locked|committed|executing|completed|failed
    lock_level TEXT DEFAULT 'none',          -- none|soft|hard
    source TEXT NOT NULL DEFAULT 'auto',     -- auto|manual|reshuffle
    order_id TEXT REFERENCES orders(id),
    plan_id TEXT REFERENCES plans(id),
    opportunity_id TEXT,
    quality_score REAL,
    maneuver_time_s REAL,
    slack_time_s REAL,
    workspace_id TEXT REFERENCES workspaces(id)
);
```

### Plans Table
Candidate schedules generated by planning algorithms.

```sql
CREATE TABLE plans (
    id TEXT PRIMARY KEY,                    -- plan_xxxxxxxxxxxx
    created_at TEXT NOT NULL,
    algorithm TEXT NOT NULL,
    config_json TEXT NOT NULL,
    input_hash TEXT NOT NULL,               -- For reproducibility
    run_id TEXT NOT NULL,
    score REAL,
    metrics_json TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'candidate', -- candidate|committed|superseded|rejected
    workspace_id TEXT REFERENCES workspaces(id)
);
```

### Plan Items Table
Individual scheduled opportunities within a plan.

```sql
CREATE TABLE plan_items (
    id TEXT PRIMARY KEY,                    -- planitem_xxxxxxxxxxxx
    plan_id TEXT NOT NULL REFERENCES plans(id) ON DELETE CASCADE,
    opportunity_id TEXT NOT NULL,
    satellite_id TEXT NOT NULL,
    target_id TEXT NOT NULL,
    start_time TEXT NOT NULL,
    end_time TEXT NOT NULL,
    roll_angle_deg REAL NOT NULL,
    pitch_angle_deg REAL DEFAULT 0.0,
    value REAL,
    quality_score REAL,
    maneuver_time_s REAL,
    slack_time_s REAL,
    order_id TEXT REFERENCES orders(id)
);
```

### Conflicts Table
Detected scheduling conflicts (for future conflict detection).

```sql
CREATE TABLE conflicts (
    id TEXT PRIMARY KEY,
    detected_at TEXT NOT NULL,
    type TEXT NOT NULL,                     -- temporal_overlap|slew_infeasible|resource_contention
    severity TEXT NOT NULL DEFAULT 'error', -- error|warning|info
    description TEXT,
    acquisition_ids_json TEXT NOT NULL,     -- JSON array
    resolved_at TEXT,
    resolution_action TEXT,
    resolution_notes TEXT,
    workspace_id TEXT REFERENCES workspaces(id)
);
```

### Schema Migrations Table
Tracks applied migrations for version control.

```sql
CREATE TABLE schema_migrations (
    version TEXT PRIMARY KEY,
    applied_at TEXT NOT NULL,
    description TEXT
);
```

## API Endpoints

### Orders API (`/api/v1/orders`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/orders` | Create new order |
| GET | `/api/v1/orders` | List orders with filters |
| GET | `/api/v1/orders/{id}` | Get single order |
| PATCH | `/api/v1/orders/{id}` | Update order status |

**Create Order Request:**
```json
{
  "target_id": "Target-Alpha",
  "priority": 4,
  "constraints": {
    "max_incidence_deg": 35,
    "look_side": "RIGHT"
  },
  "requested_window_start": "2026-01-22T00:00:00Z",
  "requested_window_end": "2026-01-29T00:00:00Z",
  "workspace_id": "ws_abc123"
}
```

**List Orders Query Parameters:**
- `status`: Filter by status (new|planned|committed|cancelled|completed)
- `workspace_id`: Filter by workspace
- `limit`: Max results (default 100)
- `offset`: Pagination offset

### Schedule API (`/api/v1/schedule`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/schedule/state` | Get current schedule state |
| GET | `/api/v1/schedule/horizon` | Get acquisitions in time window |
| POST | `/api/v1/schedule/commit` | Commit a plan |
| POST | `/api/v1/schedule/commit/direct` | Direct commit (for frontend) |

**Get Horizon Query Parameters:**
- `from`: Start time (ISO datetime, default: now)
- `to`: End time (ISO datetime, default: +7 days)
- `workspace_id`: Filter by workspace
- `include_tentative`: Include tentative acquisitions (default: true)

**Horizon Response:**
```json
{
  "success": true,
  "horizon": {
    "start": "2026-01-22T10:00:00Z",
    "end": "2026-01-29T10:00:00Z",
    "freeze_cutoff": "2026-01-22T12:00:00Z"
  },
  "acquisitions": [
    {
      "id": "acq_abc123",
      "satellite_id": "ICEYE-X44",
      "target_id": "Target-Alpha",
      "start_time": "2026-01-23T14:30:00Z",
      "end_time": "2026-01-23T14:30:05Z",
      "state": "committed",
      "lock_level": "soft"
    }
  ],
  "statistics": {
    "total_acquisitions": 15,
    "by_state": {"committed": 10, "tentative": 5},
    "by_satellite": {"ICEYE-X44": 8, "ICEYE-X45": 7}
  }
}
```

**Direct Commit Request (Frontend "Promote to Orders"):**
```json
{
  "items": [
    {
      "opportunity_id": "ICEYE-X44_Target-Alpha_0_max",
      "satellite_id": "ICEYE-X44",
      "target_id": "Target-Alpha",
      "start_time": "2026-01-23T14:30:00Z",
      "end_time": "2026-01-23T14:30:05Z",
      "roll_angle_deg": 12.5,
      "pitch_angle_deg": 0.0,
      "value": 1.0
    }
  ],
  "algorithm": "roll_pitch_best_fit",
  "mode": "OPTICAL",
  "lock_level": "soft",
  "workspace_id": "ws_abc123"
}
```

### Planning API (Updated)

The planning endpoint now supports incremental mode:

**POST `/api/planning/schedule`**

```json
{
  "mode": "incremental",
  "workspace_id": "ws_abc123",
  "imaging_time_s": 5.0,
  "algorithms": ["roll_pitch_best_fit"]
}
```

**Mode Options:**
- `from_scratch` (default): Ignores existing acquisitions
- `incremental`: Loads committed acquisitions and filters out conflicting opportunities

## Frontend Integration

### Schedule API Client

Location: `frontend/src/api/scheduleApi.ts`

```typescript
import { commitScheduleDirect, getScheduleHorizon } from '../api/scheduleApi';

// Commit a schedule to the database
const result = await commitScheduleDirect({
  items: scheduleItems,
  algorithm: 'roll_pitch_best_fit',
  mode: 'OPTICAL',
  workspace_id: 'ws_abc123'
});

// Query committed acquisitions
const horizon = await getScheduleHorizon({
  from: '2026-01-22T00:00:00Z',
  to: '2026-01-29T00:00:00Z',
  workspace_id: 'ws_abc123'
});
```

### "Promote to Orders" Workflow

The `LeftSidebar` component's "Promote to Orders" button now:

1. Calls `commitScheduleDirect()` to persist acquisitions to the database
2. Falls back to localStorage if backend is unavailable
3. Updates local Zustand store for immediate UI feedback

```typescript
const handlePromoteToOrders = async (algorithm, result) => {
  // Build commit items from schedule
  const commitItems = result.schedule.map(s => ({
    opportunity_id: s.opportunity_id,
    satellite_id: s.satellite_id,
    // ... other fields
  }));

  // Commit to backend
  const response = await commitScheduleDirect({
    items: commitItems,
    algorithm,
    workspace_id: activeWorkspace
  });

  // Update local state for UI
  setOrders(prev => [...prev, newOrder]);
};
```

## Backward Compatibility

### Legacy Data Migration

When loading a workspace that has `orders_state_json` (v1 format) but no v2 acquisitions, the system automatically migrates:

1. Detects legacy `orders_state.orders[]` in workspace blob
2. For each AcceptedOrder:
   - Creates a `plans` record
   - Creates `plan_items` records
   - Creates `acquisitions` records (state: committed)
3. Marks plan as committed

This migration runs once per workspace on first load after upgrade.

### localStorage Fallback

The frontend maintains localStorage backup for orders, ensuring the UI works even if the backend is temporarily unavailable.

## Usage Examples

### 1. Create and Commit a Schedule

```python
# Backend example
from backend.schedule_persistence import get_schedule_db

db = get_schedule_db()

# Create a plan
plan = db.create_plan(
    algorithm="roll_pitch_best_fit",
    config={"imaging_time_s": 5.0},
    input_hash="sha256:abc123",
    run_id="run_20260122_143000_xyz",
    metrics={"accepted": 10, "rejected": 2},
    workspace_id="ws_abc123"
)

# Add plan items
for item in schedule:
    db.create_plan_item(
        plan_id=plan.id,
        opportunity_id=item["opportunity_id"],
        satellite_id=item["satellite_id"],
        # ...
    )

# Commit the plan
result = db.commit_plan(
    plan_id=plan.id,
    item_ids=[],  # Empty = commit all
    lock_level="soft",
    mode="OPTICAL",
    workspace_id="ws_abc123"
)
# result = {"committed": 10, "acquisitions_created": [...], "orders_updated": [...]}
```

### 2. Query Schedule Horizon

```python
# Get all committed acquisitions in a time window
acquisitions = db.get_acquisitions_in_horizon(
    start_time="2026-01-22T00:00:00Z",
    end_time="2026-01-29T00:00:00Z",
    workspace_id="ws_abc123",
    include_tentative=False
)

for acq in acquisitions:
    print(f"{acq.satellite_id} -> {acq.target_id} at {acq.start_time}")
```

### 3. Incremental Planning

```python
# Get blocked intervals for a satellite
blocked = db.get_committed_acquisitions_for_satellite(
    satellite_id="ICEYE-X44",
    start_time="2026-01-22T00:00:00Z",
    end_time="2026-01-29T00:00:00Z",
    workspace_id="ws_abc123"
)

# Filter opportunities that don't conflict
available_opportunities = [
    opp for opp in opportunities
    if not conflicts_with_any(opp, blocked)
]
```

## File Structure

```
backend/
├── schedule_persistence.py      # NEW: ScheduleDB class, data models
├── routers/
│   ├── orders.py               # NEW: Orders CRUD endpoints
│   ├── schedule.py             # UPDATED: Real horizon + commit endpoints
│   └── workspaces.py           # UPDATED: Migration on load
└── main.py                     # UPDATED: Incremental mode, new router

frontend/src/
├── api/
│   └── scheduleApi.ts          # NEW: Schedule API client
└── components/
    └── LeftSidebar.tsx         # UPDATED: Backend commit on promote
```

## Testing

### Verify Schema Migration

```bash
python -c "
from backend.schedule_persistence import get_schedule_db
db = get_schedule_db()
print('Schema initialized successfully')
"
```

### Test Commit Flow

```bash
curl -X POST http://localhost:8000/api/v1/schedule/commit/direct \
  -H 'Content-Type: application/json' \
  -d '{
    "items": [{
      "opportunity_id": "test_opp_1",
      "satellite_id": "SAT-1",
      "target_id": "TGT-1",
      "start_time": "2026-01-23T14:30:00Z",
      "end_time": "2026-01-23T14:30:05Z",
      "roll_angle_deg": 10.0
    }],
    "algorithm": "test",
    "mode": "OPTICAL"
  }'
```

### Test Horizon Query

```bash
curl "http://localhost:8000/api/v1/schedule/horizon?from=2026-01-22T00:00:00Z&to=2026-01-30T00:00:00Z"
```

## Future Enhancements

1. **Conflict Detection**: Implement automatic conflict detection when committing
2. **Reshuffle**: Add ability to reschedule around committed acquisitions
3. **Order Fulfillment**: Track which orders are fulfilled by which acquisitions
4. **Audit Trail**: Add detailed logging of all schedule changes
5. **Multi-user**: Add user attribution to orders and plans
